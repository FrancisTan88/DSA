<!DOCTYPE html>
<html>
<head>
<style>
table, td, th {
  border: 1px solid;
}
table {
  border-collapse: collapse;
}
</style>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    $(document).ready(function () {
	$("#redirect").click(function(){
        window.location = 'Delete.html';
    });
	 var rowIdx = 0;
	$("#query").click(function(){
		$('#userIdUpdate').text('');
		$('#tbody').empty();
		rowIdx = 0;
		$.ajax( {
                   type: 'get',
                   url: 'https://localhost:7106/Order/' + $('#queryOrderId').val(),
				   async: false,
                   dataType: 'json',
                   contentType: "application/json; charset=utf-8",
                   success: function ( data )
                   {
						$('#userIdUpdate').text($('#userId').val())
						$('#orderId').text(data.orderId);
						$('#totalPrice').text(data.totalPrice == null ? '0' : data.totalPrice);
						for (let i = 0; i < data.orderItems.length; i++) {
							$('#tbody').append(`<tr id="R${++rowIdx}">
													<td class="row-index text-center">
														<p>${rowIdx}</p>
													</td>
													<td class="row-index text-center">
														<input type="text" name="itemId" value="${data.orderItems[i].itemId}" />
													</td>
													<td class="row-index text-center">
														<input type="text" name="itemName" value="${data.orderItems[i].name}" />
													</td>
													<td class="row-index text-center">
														<input type="text" name="unitPrice" value="${data.orderItems[i].unitPrice}" />
													</td>
													<td class="row-index text-center">
														<input type="text" name="qty" value="${data.orderItems[i].qty}" />
													</td>
													<td class="text-center">
													<button class="btn btn-danger remove" type="button">Remove</button>
													</td>
												</tr>`);
							//var tr = $('#R' + rowIdx);
							//tr.find('td input[name="itemId"]').val()
						}
                   },
                   error: function ( jqXHR, textStatus, errorThrown )
                   {
                   }
               } );
    });
	$("#update").click(function(){
		const Products = [];
	    let trs = $('#tbody tr');
		for (let i = 0; i < trs.length; i++) {
			Products.push(
			{
			   itemId : $('#R' + (i + 1) + ' td input[name="itemId"]').val(),
			   itemName : $('#R' + (i + 1) + ' td input[name="itemName"]').val(),
			   unitPrice : parseInt($('#R' + (i + 1) + ' td input[name="unitPrice"]').val()),
			   qty : parseInt($('#R' + (i + 1) + ' td input[name="qty"]').val())
			});
		}
		
		let dataInfo = {
			orderId: $('#orderId').text(),
			userId: $('#userIdUpdate').text(),
			paymentType: parseInt($('#paymentType').text()),
			products: Products
		   };
		console.log(dataInfo);
		$.ajax( {
                   type: 'post',
                   url: 'https://localhost:7106/Order/Update',
				   async: false,
                   data: JSON.stringify(dataInfo),
                   dataType: 'json',
                   contentType: "application/json; charset=utf-8",
                   success: function ( data )
                   {
                      $('#totalPrice').text(data.totalPrice);
					  alert('Success');
                   },
                   error: function ( jqXHR, textStatus, errorThrown )
                   {
                   }
               } );
      });
	
	
      $('#addRow').on('click', function () {
        $('#tbody').append(`<tr id="R${++rowIdx}">
								<td class="row-index text-center">
									<p>${rowIdx}</p>
								</td>
								<td class="row-index text-center">
									<input type="text" id="itemId_{++rowIdx}" name="itemId" />
								</td>
								<td class="row-index text-center">
									<input type="text" id="itemName_{++rowIdx}" name="itemName" />
								</td>
								<td class="row-index text-center">
									<input type="text" id="unitPrice_{++rowIdx}" name="unitPrice" />
								</td>
								<td class="row-index text-center">
									<input type="text" id="qty_{++rowIdx}" name="qty" />
								</td>
								<td class="text-center">
								<button class="btn btn-danger remove" type="button">Remove</button>
								</td>
							</tr>`);
      });
      $('#tbody').on('click', '.remove', function () {
        var child = $(this).closest('tr').nextAll();
        child.each(function () {
          var id = $(this).attr('id');
          var idx = $(this).children('.row-index').children('p');
          var dig = parseInt(id.substring(1));
          idx.html(`Row ${dig - 1}`);
          $(this).attr('id', `R${dig - 1}`);
        });
        $(this).closest('tr').remove();
        rowIdx--;
      });
    });
  </script>
</head>
<body>
	<label for="userId">UserId:</label>
	<input type="text" id="userId" name="userId"><br><br>
	<label for="queryOrderId">OrderId:</label>
	<input type="text" id="queryOrderId" name="queryOrderId"><br><br>
	<button type="button" id="query">Query</button>
	<button type="button" id="redirect">redirect</button>
	<br/>
	<br/>
	<div>
		<label>OrderId:</label><label id="orderId"></label><br><br>
		<label>UserId:</label><label id="userIdUpdate"></label><br><br>
		<label>TotalPrice:</label><label id="totalPrice"></label><br><br>
		<label>PaymentType:</label><label id="paymentType">0</label><br><br>
	</div>
    <div>
      <div>
        <table>
          <thead>
            <tr>
              <th class="text-center">Row Number</th>
			  <th class="text-center">ItemId</th>
			  <th class="text-center">ItemName</th>
			  <th class="text-center">UnitPrice</th>
			  <th class="text-center">Qty</th>
              <th class="text-center">Remove Row</th>
            </tr>
          </thead>
          <tbody id="tbody">
          </tbody>
        </table>
      </div>
	  <br/>
	  <br/>
      <button type="button" id="addRow"> Add new Row </button>
	  <button type="button" id="update">Update</button>
    </div>
</body>
</html>